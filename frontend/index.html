<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoldenNoise 数据采集平台</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .image-card {
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .image-card img {
            width: 100%;
            height: 250px;
            object-fit: cover;
        }
        .image-info {
            padding: 10px;
        }
        .image-info p {
            margin: 5px 0;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
        }
        .checkbox-container input {
            width: auto;
            margin-right: 5px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>GoldenNoise 数据采集平台</h1>
        
        <div class="tabs">
            <div class="tab active" data-tab="settings">参数设置</div>
            <div class="tab" data-tab="workspace">工作台</div>
        </div>
        
        <div class="tab-content active" id="settings-tab">
            <h2>模型参数设置</h2>
            
            <div id="settings-status" class="status hidden"></div>
            
            <form id="settings-form">
                <div class="form-group">
                    <label for="model">模型选择</label>
                    <select id="model" name="model">
                        <option value="FLux.1-schnell">FLux1.dev-schnell</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="steps">推理步数 (steps)</label>
                    <input type="number" id="steps" name="steps" value="20" min="1" max="100">
                </div>
                
                <div class="form-group">
                    <label for="cfg_scale">CFG Scale</label>
                    <input type="number" id="cfg_scale" name="cfg_scale" value="7.0" step="0.1" min="1" max="20">
                </div>
                
                <div class="form-group">
                    <label for="num_images">每批图像数量</label>
                    <input type="number" id="num_images" name="num_images" value="20" min="1" max="16">
                </div>
                
                <div class="form-group">
                    <label for="prompt_file">Prompt 文件 (CSV/JSON)</label>
                    <input type="file" id="prompt_file" name="prompt_file" accept=".csv,.json">
                </div>
                
                <button type="button" id="init-model-btn">初始化模型</button>
            </form>
        </div>
        
        <div class="tab-content" id="workspace-tab">
            <h2>工作台</h2>
            
            <div id="workspace-status" class="status hidden"></div>
            
            <div class="form-group">
                <label for="current-prompt">当前 Prompt</label>
                <input type="text" id="current-prompt" readonly>
            </div>
            
            <button type="button" id="generate-btn" disabled>生成图像</button>
            <button type="button" id="submit-btn" disabled>提交选择</button>
            <button type="button" id="next-btn" disabled>下一组</button>
            
            <div id="image-container" class="image-grid">
                <!-- 图像将在这里显示 -->
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentImages = [];
        let currentPrompt = "";
        let selectedImages = [];
        let promptList = [];
        let currentPromptIndex = 0;
        
        // DOM 元素
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const settingsStatus = document.getElementById('settings-status');
        const workspaceStatus = document.getElementById('workspace-status');
        const initModelBtn = document.getElementById('init-model-btn');
        const generateBtn = document.getElementById('generate-btn');
        const submitBtn = document.getElementById('submit-btn');
        const nextBtn = document.getElementById('next-btn');
        const imageContainer = document.getElementById('image-container');
        const currentPromptInput = document.getElementById('current-prompt');
        
        // 切换标签页
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // 更新活动标签
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(tc => tc.classList.remove('active'));
                
                tab.classList.add('active');
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });
        
        // 处理Prompt文件上传
        document.getElementById('prompt_file').addEventListener('change', handlePromptFileUpload);
        
        // 处理Prompt文件上传到后端
        async function handlePromptFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('http://localhost:8000/upload_prompts', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showStatus(settingsStatus, result.message, 'success');
                    
                    // 从后端获取Prompt列表
                    await fetchPromptList();
                } else {
                    showStatus(settingsStatus, `上传失败: ${result.message}`, 'error');
                }
            } catch (error) {
                showStatus(settingsStatus, `上传请求失败: ${error.message}`, 'error');
            }
        }
        
        // 从后端获取Prompt列表
        async function fetchPromptList() {
            try {
                const response = await fetch('http://localhost:8000/get_prompts');
                const result = await response.json();
                
                if (result.status === 'success') {
                    promptList = result.prompts;
                    showStatus(settingsStatus, `成功获取 ${promptList.length} 个Prompt`, 'success');
                } else {
                    showStatus(settingsStatus, `获取Prompt列表失败: ${result.message}`, 'error');
                }
            } catch (error) {
                showStatus(settingsStatus, `获取Prompt列表请求失败: ${error.message}`, 'error');
            }
        }
        
        // 初始化模型
        initModelBtn.addEventListener('click', async () => {
            showStatus(settingsStatus, '正在初始化模型...', 'success');
            
            try {
                const response = await fetch('http://localhost:8000/init_model', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showStatus(settingsStatus, '模型初始化成功！', 'success');
                    generateBtn.disabled = false;
                    nextBtn.disabled = false;
                } else {
                    showStatus(settingsStatus, `模型初始化失败: ${result.message}`, 'error');
                }
            } catch (error) {
                showStatus(settingsStatus, `请求失败: ${error.message}`, 'error');
            }
        });
        
        // 处理Prompt文件
        function handlePromptFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                if (file.name.endsWith('.csv')) {
                    parseCSV(content);
                } else if (file.name.endsWith('.json')) {
                    parseJSON(content);
                }
            };
            reader.readAsText(file);
        }
        
        // 解析CSV文件
        function parseCSV(content) {
            const lines = content.split('\n');
            promptList = [];
            
            // 跳过标题行，从第二行开始处理
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    // 简单的CSV解析，按逗号分割
                    const fields = line.split(',');
                    // 假设caption在第二列（索引1）
                    if (fields.length > 1) {
                        promptList.push(fields[1]);
                    }
                }
            }
            
            showStatus(settingsStatus, `成功加载 ${promptList.length} 个Prompt`, 'success');
        }
        
        // 解析JSON文件
        function parseJSON(content) {
            try {
                const data = JSON.parse(content);
                promptList = [];
                
                // 根据JSON结构提取prompt
                if (Array.isArray(data)) {
                    // 如果是数组，假设每个元素都有caption字段
                    promptList = data.map(item => item.caption || item.prompt || '');
                } else if (data.prompts) {
                    // 如果有prompts字段
                    promptList = data.prompts;
                } else {
                    // 尝试其他可能的结构
                    for (const key in data) {
                        if (typeof data[key] === 'string') {
                            promptList.push(data[key]);
                        }
                    }
                }
                
                showStatus(settingsStatus, `成功加载 ${promptList.length} 个Prompt`, 'success');
            } catch (error) {
                showStatus(settingsStatus, `JSON解析失败: ${error.message}`, 'error');
            }
        }
        
        // 生成图像
        generateBtn.addEventListener('click', async () => {
            // 获取参数
            let prompt = "A beautiful landscape"; // 默认prompt
            
            // 如果有prompt列表，则使用当前prompt
            if (promptList.length > 0 && currentPromptIndex < promptList.length) {
                prompt = promptList[currentPromptIndex];
            }
            
            const steps = parseInt(document.getElementById('steps').value);
            const cfgScale = parseFloat(document.getElementById('cfg_scale').value);
            const numImages = parseInt(document.getElementById('num_images').value);
            
            currentPrompt = prompt;
            currentPromptInput.value = prompt;
            
            showStatus(workspaceStatus, '正在生成图像...', 'success');
            
            try {
                const formData = new FormData();
                formData.append('prompt', prompt);
                formData.append('steps', steps);
                formData.append('cfg_scale', cfgScale);
                formData.append('num_images', numImages);
                
                const response = await fetch('http://localhost:8000/generate_batch', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showStatus(workspaceStatus, '图像生成成功！', 'success');
                    displayImages(result.images);
                    submitBtn.disabled = false;
                    nextBtn.disabled = false;
                } else {
                    showStatus(workspaceStatus, `图像生成失败: ${result.message}`, 'error');
                }
            } catch (error) {
                showStatus(workspaceStatus, `请求失败: ${error.message}`, 'error');
            }
        });
        
        // 显示图像
        function displayImages(images) {
            currentImages = images;
            selectedImages = [];
            
            imageContainer.innerHTML = '';
            
            images.forEach((imgData, index) => {
                const card = document.createElement('div');
                card.className = 'image-card';
                
                card.innerHTML = `
                    <img src="data:image/png;base64,${imgData.image}" alt="Generated Image">
                    <div class="image-info">
                        <p><strong>Seed:</strong> ${imgData.seed}</p>
                        <p><strong>CLIP Score:</strong> ${imgData.clip_score.toFixed(4)}</p>
                        <div class="checkbox-container">
                            <input type="checkbox" id="select-${index}" data-index="${index}">
                            <label for="select-${index}">选择为 Golden Image</label>
                        </div>
                    </div>
                `;
                
                imageContainer.appendChild(card);
                
                // 添加选择事件监听器
                const checkbox = card.querySelector(`#select-${index}`);
                checkbox.addEventListener('change', (e) => {
                    const idx = parseInt(e.target.getAttribute('data-index'));
                    if (e.target.checked) {
                        selectedImages.push(idx);
                    } else {
                        const selectedIndex = selectedImages.indexOf(idx);
                        if (selectedIndex > -1) {
                            selectedImages.splice(selectedIndex, 1);
                        }
                    }
                });
            });
        }
        
        // 提交选择
        submitBtn.addEventListener('click', async () => {
            if (selectedImages.length === 0) {
                showStatus(workspaceStatus, '请至少选择一张图像', 'error');
                return;
            }
            
            const selectionData = {
                prompt: currentPrompt,
                golden_images: selectedImages.map(idx => ({
                    seed: currentImages[idx].seed,
                    clip_score: currentImages[idx].clip_score,
                    image_path: currentImages[idx].image_path
                })),
                all_images: currentImages.map(img => ({
                    seed: img.seed,
                    clip_score: img.clip_score,
                    image_path: img.image_path
                }))
            };
            
            try {
                const response = await fetch('http://localhost:8000/submit_selection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(selectionData)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showStatus(workspaceStatus, '选择已提交！', 'success');
                } else {
                    showStatus(workspaceStatus, `提交失败: ${result.message}`, 'error');
                }
            } catch (error) {
                showStatus(workspaceStatus, `请求失败: ${error.message}`, 'error');
            }
        });
        
        // 下一组
        nextBtn.addEventListener('click', () => {
            // 从prompt文件中获取下一个prompt
            if (promptList.length > 0) {
                currentPromptIndex++;
                if (currentPromptIndex >= promptList.length) {
                    currentPromptIndex = 0; // 循环回到第一个prompt
                    showStatus(workspaceStatus, 'PromptList迭代完成', 'error');
                }
                currentPrompt = promptList[currentPromptIndex];
                currentPromptInput.value = currentPrompt;
                showStatus(workspaceStatus, `获取下一组Prompt (${currentPromptIndex + 1}/${promptList.length})...`, 'success');
                // generateBtn.click();
            } else {
                showStatus(workspaceStatus, 'PromptList长度错误', 'error');
            }
        });
        
        // 显示状态消息
        function showStatus(element, message, type) {
            element.textContent = message;
            element.className = `status ${type}`;
            element.classList.remove('hidden');
            
            // 3秒后自动隐藏成功消息
            if (type === 'success') {
                setTimeout(() => {
                    element.classList.add('hidden');
                }, 3000);
            }
        }
    </script>
</body>
</html>
